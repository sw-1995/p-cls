# AI 引導技術範圍的 Prompt 設計計畫範例

## 目標

1. 把客戶的初始描述（關鍵詞、產品、少量案例、或粗略 taxonomy）轉成**可操作**的範圍定義：

    * `include_topics` / `exclude_topics`
    * `scope_axis`（產品/技術/市場/上下游）
    * `granularity`（三層以內）
    * `near_misses`（看起來像、其實不算）
    * `decision_questions`（人審決策問句）

2. 自動偵測**過大**或**過小**，並提出**具體收斂/擴張建議**，以核取清單（checkbox）形式回饋。

3. 產出**版本化**的「範圍憲章」（scope charter），作為後續檢索與分類的依據。

## 總流程（4 階段 + 2 個迴圈）

1. **範圍盤點 (Scope Scan)**：讀初始輸入 → 估計「過大/過小」風險 → LLM直接給出初步範圍建議清單。
2. **收斂/擴張 (Refine)**：
   * 若過大 → 拆成 4–8 個子領域、讓客戶勾選；
   * 若過小 → 提出相鄰/父級技術、讓客戶擴張勾選。
3. **邊界確認 (Boundary Set)**：上下游、應用場景、是否含製程/材料、是否含跨域移轉…
4. **範圍憲章 (Scope Charter)**：輸出標準化 JSON（含 synonyms、near_misses、CPC/IPC anchors 供檢索 prior）。

## 介面資料（流入 LLM 的上下文）

* `customer_inputs`:

  * `keywords`: 客戶提供字詞
  * `examples_labeled`: 每類 1–5 範例（可為空）
  * `taxonomy_seed`: 初稿（可為空）
* `retrieval_signals`（由系統計算，供 LLM 參考，非必要）：

  * `cluster_names`、`cluster_sizes`（embedding 聚類）
  * `cpc_histogram`（CPC/IPC 熱點）
  * `doc_count_estimate`（資料夾中文件數）
* `constraints`: `max_layers=3`、語言、是否允許多標籤
* `ui_state`: 先前回合的勾選結果（Refine 回填）

## 模組化 Prompt 範例

### M1. 範圍盤點（Scope Scan）

**用途**：初步判斷過大/過小，輸出候選子領域（用詞統一、避免重複）。
**輸入**：`customer_inputs`, `retrieval_signals`, `constraints`
**輸出 JSON（示例）**：

```json
{
  "breadth_risk": "too_broad | too_narrow | balanced",
  "rationale": ["..."],
  "suggest_subtopics": [
    {"name":"Battery/BMS","desc":"...", "aliases":["battery management"], "reason":"..."},
    {"name":"Battery/Cell","desc":"...", "aliases":["cell design"], "reason":"..."}
  ],
  "suspected_gaps": ["SoH estimation", "thermal runaway"],
  "near_misses": ["power supply PMIC", "generic charger IC"]
}
```

**Prompt（系統 + 使用者）**：

> 請gpt多幫你修正prompt，因為這會決定它界定範圍的成功度

```txt
[SYSTEM]
You are a Taxonomy Scope Analyst. Judge scope size and propose concrete subtopics.
- Use only given inputs. Do not invent facts.
- Return STRICT JSON with fields: breadth_risk, rationale[], suggest_subtopics[], suspected_gaps[], near_misses[].
- Subtopic names must be mutually exclusive and non-redundant. Use ≤ 3 levels in "name" with "/" as separator.

[USER]
Customer inputs:
{customer_inputs}

Retrieval signals (optional):
{retrieval_signals}

Constraints:
{constraints}
```

### M2. 收斂（Narrowing）—適用於過大

**用途**：把大範圍拆成 4–8 個可勾選子領域，附定義、包含/不包含示例。
**輸入**：M1 的 `suggest_subtopics`、`near_misses`、先前勾選（若有）
**輸出 JSON**：

```json
{
  "narrow_options": [
    {
      "name": "Battery/BMS",
      "definition": "...",
      "include_examples": ["..."],
      "exclude_examples": ["..."],
      "decision_questions": ["是否含充電樁 BMS？", "是否包含 SoH 估算？"]
    }
  ],
  "default_checked": ["Battery/BMS","Battery/Cell"]
}
```

**Prompt**：

```txt
[SYSTEM]
You are a Scope Refiner. Produce 4–8 checkable subtopics with crisp definitions and include/exclude examples.
Return STRICT JSON with fields: narrow_options[], default_checked[].

[USER]
Broad scope to refine:
{subtopics_from_M1}

Known near-misses (avoid):
{near_misses}

Previously checked (if any):
{ui_state}
```

### M3. 擴張（Broadening）—適用於過小

**用途**：找出合理的相鄰/父級技術，避免過窄導致召回不足。
**輸入**：M1/M2 結果、`retrieval_signals.cpc_histogram`（可選）
**輸出 JSON**：

```json
{
  "adjacent_topics": [
    {"name":"Battery/SoH", "why_related":"..."},
    {"name":"Battery/Balancing", "why_related":"..."}
  ],
  "parent_topics": [{"name":"Battery", "value":"聚合到父階減少碎片"}],
  "recommend_add": ["Battery/SoH","Battery/Balancing"]
}
```

**Prompt**：

```txt
[SYSTEM]
You are a Scope Broadener. Propose adjacent or parent topics that reduce over-narrowness.
Return STRICT JSON with: adjacent_topics[], parent_topics[], recommend_add[].

[USER]
Current too-narrow scope:
{current_scope}

Signals:
{retrieval_signals}
```

### M4. 邊界設定（Boundary Set）

**用途**：把易混淆的「上下游/應用/地域/時序」邊界寫清楚。
**輸入**：已勾選的子領域列表
**輸出 JSON**：

```json
{
  "boundary": {
    "value_chain": {"include":["cell","BMS"], "exclude":["grid","charger"]},
    "application": {"include":["EV"], "exclude":["laptop"]},
    "process_material": {"include":["electrode coating"], "exclude":["foundry process"]},
    "geography": {"notes":"不限地區"},
    "timeframe": {"notes":"不限年份"}
  },
  "near_misses": ["PMIC not dedicated to battery", "generic power adapters"]
}
```

**Prompt**：

```txt
[SYSTEM]
You are a Boundary Setter. Translate choices into explicit include/exclude boundaries for value chain, application, process/material, geography, timeframe. Add near_misses.

[USER]
Chosen topics:
{chosen_topics}
```

### M5. 範圍憲章（Scope Charter / Canonicalization）

**用途**：輸出「可運行」的最終範圍檔（供檢索 prior + 分類），含 synonyms/near_misses/decision_questions/CPC anchors。
**輸入**：M2/M3/M4 彙整、（可選）客戶案例
**輸出 JSON（最終）**：

```json
{
  "version": "scope_v1",
  "max_layers": 3,
  "labels": [
    {
      "name": "Battery/BMS",
      "definition": "...",
      "synonyms": ["battery management","BMS"],
      "near_misses": ["charger PMIC"],
      "decision_questions": ["文本是否涉及SOC/SOH估算或均衡控制？"],
      "cpc_anchors": ["H02J7/00","B60L53/80"]
    }
  ],
  "global_exclude": ["generic PMIC","AC chargers"]
}
```

**Prompt**：

```txt
[SYSTEM]
You are a Canonicalizer. Produce a production-ready scope charter JSON.
- ≤3 layers
- Unique names, non-overlapping
- Add synonyms, near_misses, decision_questions
- Optional: CPC anchors for retrieval prior
- STRICT JSON only

[USER]
Refined scope components:
{refined_components}
```

### M6. 展示式驗證（Evidence Review Loop）

**用途**：用目前範圍抽取「正例 vs 近似錯誤例」各 3–5 篇，請客戶快速「打勾/刪除」。
**輸入**：`scope_charter`, 系統檢索到的樣本（由系統提供 `candidate_positives` / `candidate_near_misses`）
**輸出 JSON**：

```json
{
  "review_pack": {
    "positives": [{"patent_id":"...", "why":["..."]}],
    "near_misses": [{"patent_id":"...", "why":["..."]}]
  },
  "revise_suggestions": ["將 'charger' 移至 global_exclude"]
}
```

**Prompt**：

```txt
[SYSTEM]
You are a Review Pack Builder. From provided candidates, pick 3–5 positives and 3–5 near-misses that best test the boundaries. Provide short "why" using quotes.

[USER]
Scope charter:
{scope_charter}

Candidate samples (from retrieval):
{candidate_samples}
```

## 運行策略與觸發規則

* **判斷「過大/過小」門檻（可由系統傳入給 LLM，或 LLM 自評）**

  * `cluster_count > 6` 且 `silhouette < 0.2` → 偏**過大**
  * `cluster_count < 2` 或 `doc_count_estimate < 50` → 偏**過小**
  * `cpc_entropy` 高 → **過大**；極低 → **過小**

* **分支**

  * `too_broad` → 走 M2（收斂）
  * `too_narrow` → 走 M3（擴張）
  * 兩者皆非 → 直接 M4 → M5

* **版本化**

  * `scope_v{n}`：每次 M6 客戶勾選後 +1；存檔於 `/output/<RUN_ID>/scope_charter_v{n}.json`

## LangChain / DSPy 接法（簡述）

* LangChain：以 `RunnableSequence` 依序連接 M1→(M2|M3)→M4→M5→M6，所有步驟都做 **JSON schema 驗證 + 自動重試**。
* DSPy（可選）：把 M2/M3/M5 做成 `Signature`，用資料夾內少量標記或先前歷史決策例做 **BootstrapFewShot**，自動優化回傳的子領域品質與用詞一致性。

## UI/對話建議（提高完成率）

* **Checkbox 清單**：M2/M3 的 `default_checked` 給「八二原則」預選，讓客戶只需反選/增刪。
* **三層視覺限制**：UI 僅顯示 3 層；更深層另用 tooltip 說明，避免客戶越聊越碎。
* **即時預覽**：每次勾選後，右側即時顯示「將會包含/排除的代表性專利」1–2 篇（來自 M6 的候選池）。
* **近似錯誤例提示**：在每個子領域旁顯示 1 條 `near_miss`，提醒不要選過頭。

## 成功判準（Acceptance）

* 產出 `scope_charter.json`，可直接餵到分類管線（Retriever prior + Label Canonicalizer）。
* M6 的審查包通過：客戶對正例接受度 ≥ 80%；對 near-miss 的排除度 ≥ 80%。
* 後續分類批次（小樣本）Macro-F1 至少不低於「未做範圍引導」的基線。

## 迷你範例（精簡）

**初始**：客戶輸入「電池相關專利」。

* M1：判定 `too_broad`，建議子領域：`Battery/BMS`、`Battery/Cell`、`Battery/Thermal`、`ChargingInfra(排除建議)`。
* M2：預選 `BMS`、`Cell`；near_miss 提醒「一般 PMIC、充電樁」。
* M4：`value_chain.include=["cell","BMS"]`；`exclude=["grid","charger"]`。
* M5：輸出 `scope_charter_v1.json`（含 synonyms/near_misses/CPC anchors）。
* M6：展示 3 正例（BMS 估算/均衡）與 3 near-miss（通用 PMIC/充電樁），客戶同意 5/6 → 回寫修正，產生 `scope_charter_v2.json`。

以上計畫把「**怎麼問**、**問什麼**、**輸出長什麼樣**」全部模板化。你只要把這些 Prompt 放進你的管線，按 `M1→(M2|M3)→M4→M5→M6` 執行，就能**系統化地避免範圍過大或過小**，並把客戶口語轉成可運行的分類範圍。需要的話，我可以把這些模組整理成一份可直接貼進專案的 `prompts/` 目錄（含 JSON Schema 驗證器與 LangChain 範例呼叫）。
