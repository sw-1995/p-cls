# 功能規格：AI 檢索 MVP v2 - 引導式混合查詢

## 🎯 核心使用者需求更新

**最新發現：** 使用者的核心痛點是**需要被引導**進行專利檢索，同時希望能夠：

1. **使用精準的自然語言句子**（例如「使用卡爾曼濾波器估算鋰電池的荷電狀態」）
2. **結合 Boolean 邏輯查詢**（AND、OR、NOT）
3. **同時附上已知專利號**（作為檢索起點或參考）

### 問題陳述

**現有工具的限制：**
- ❌ **Smart Search**：自然語言輸入，但無法結合 Boolean 或專利號
- ❌ **Advanced Search**：Boolean 查詢，但不理解自然語言
- ❌ **Semantic Search**：概念檢索，但不支援混合輸入

**使用者真正想要的：**
✅ **引導式工作流程** - 系統一步步引導建構查詢
✅ **混合輸入模式** - 自然語言 + Boolean + 專利號同時使用
✅ **智能解析與建議** - AI 理解混合查詢並提供最佳化建議
✅ **即時驗證與反饋** - 顯示查詢將返回多少結果，是否過寬/過窄

---

## 概述

### 目的

AI 檢索 MVP v2 專注於**引導式混合查詢體驗**，讓使用者能夠自由組合自然語言、Boolean 邏輯和已知專利號，並在 AI 的引導下逐步建構最佳檢索策略。

### 設計理念：引導優於自動化

**新策略：**
- 🎯 **引導式工作流程** - 分步驟引導使用者建構查詢
- 🧩 **混合查詢解析** - 理解並智能處理混合輸入
- 💡 **即時建議與驗證** - 每步都提供 AI 建議和結果預估
- 🔄 **迭代改進循環** - 支援快速測試、比較和改進

### 目標（8 週 MVP v2）

1. **減少查詢建構時間 60%**（原 50%）- 引導式工作流程 + 智能解析
2. **提高首次查詢品質 80%** - AI 引導減少試錯
3. **增加召回率 60%** - 語義檢索 + 混合查詢優化
4. **支援 100% 混合查詢場景** - 自然語言 + Boolean + 專利號
5. **使用者滿意度達 90%**（原 85%）- 引導體驗顯著提升

---

## 核心功能：引導式混合查詢系統

### 功能 0：引導式查詢建構工作流程 [P0] 🆕🔥

**解決的核心痛點：** 使用者不知道如何開始、如何組合不同查詢元素、如何優化查詢

**為何是最高優先級：**
- 🔥 **直接解決使用者核心需求** - 「希望可以被引導搜尋」
- 🔥 **差異化核心功能** - 市場上沒有引導式混合查詢工具
- 🔥 **提升所有其他功能價值** - 引導流程整合所有 AI 能力

#### 需求

**FR0.1: 三階段引導式工作流程**

**階段 1：查詢起點選擇**
```
┌────────────────────────────────────────────────────────────┐
│ 🚀 開始新的專利檢索                                          │
├────────────────────────────────────────────────────────────┤
│ 選擇您的檢索起點：                                            │
│                                                             │
│ ○ 📝 我有一個技術概念或問題描述                              │
│   範例：「使用機器學習預測電池壽命的方法」                     │
│   → 適合探索性檢索、技術景觀分析                              │
│                                                             │
│ ○ 🔍 我知道一些相關專利                                      │
│   範例：US10234567、EP3456789                               │
│   → 適合基於已知專利擴展檢索                                  │
│                                                             │
│ ○ 🎯 我有具體的關鍵字和邏輯                                  │
│   範例：(battery OR cell) AND (prediction OR estimation)   │
│   → 適合精確檢索、自由實施調查                                │
│                                                             │
│ ● 🧩 我想結合以上多種方式（推薦）                            │
│   → AI 會引導您逐步組合最佳查詢策略                           │
│                                                             │
│ [下一步：建構查詢]                                            │
└────────────────────────────────────────────────────────────┘
```

**階段 2：混合查詢輸入（智能解析）**
```
┌────────────────────────────────────────────────────────────┐
│ 🧩 建構您的混合查詢                                          │
├────────────────────────────────────────────────────────────┤
│ 輸入框（智能解析）：                                          │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ 使用卡爾曼濾波器估算鋰電池的荷電狀態                     │  │
│ │ AND (SoC OR "state of charge")                        │  │
│ │ 類似於 US10234567                                      │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                             │
│ AI 智能解析結果：                                            │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ ✅ 偵測到自然語言片段：                                 │  │
│ │    「使用卡爾曼濾波器估算鋰電池的荷電狀態」              │  │
│ │    → 將轉換為語義向量檢索                              │  │
│ │                                                        │  │
│ │ ✅ 偵測到 Boolean 運算子：                             │  │
│ │    AND (SoC OR "state of charge")                     │  │
│ │    → 將作為關鍵字篩選條件                              │  │
│ │                                                        │  │
│ │ ✅ 偵測到參考專利：                                     │  │
│ │    US10234567 - Method for battery SoC estimation     │  │
│ │    → 將用於「類似此專利」向量檢索                       │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                             │
│ AI 建議：                                                    │
│ 💡 您的查詢結合了 3 種檢索模式，這很好！                     │
│ 💡 建議增加同義詞：「電池管理」、「BMS」                      │
│ 💡 建議分類篩選：H01M10/42（電池監控）                       │
│                                                             │
│ [接受建議] [手動調整] [下一步：預覽結果]                      │
└────────────────────────────────────────────────────────────┘
```

**階段 3：查詢優化與驗證**
```
┌────────────────────────────────────────────────────────────┐
│ 🎯 查詢優化與結果預覽                                         │
├────────────────────────────────────────────────────────────┤
│ 您的最終查詢結構：                                            │
│                                                             │
│ 🔵 語義檢索層（權重 40%）                                    │
│    • 自然語言：「使用卡爾曼濾波器估算鋰電池的荷電狀態」       │
│    • 參考專利：US10234567（類似專利向量）                    │
│    預估結果：~3,500 件專利                                   │
│                                                             │
│ 🟢 關鍵字檢索層（權重 60%）                                  │
│    • Boolean：(SoC OR "state of charge") AND              │
│                (Kalman OR "Kalman filter")                 │
│    • 同義詞擴展：BMS, battery management, 電池管理          │
│    預估結果：~1,800 件專利                                   │
│                                                             │
│ 🟡 分類篩選層                                                │
│    • 主要：H01M10/42（電池監控）                             │
│    • 相鄰：H02J7/00（充電電路）、G01R31/36（電池測量）       │
│    預估結果：~4,200 件專利                                   │
│                                                             │
│ 📊 預估總結果（去重後）：約 5,100 件專利                      │
│    • 語義獨有：2,300 件（+45% 召回率）                       │
│    • 關鍵字獨有：600 件（精確匹配）                           │
│    • 重疊：2,200 件（高信心結果）                            │
│                                                             │
│ ⚠️ 查詢品質分析：                                            │
│ ✅ 範圍適中（5,100 件，適合深入分析）                         │
│ ✅ 結合多種檢索模式（平衡召回率與精確度）                     │
│ 💡 建議：可考慮添加日期範圍篩選（例如 2015-2025）            │
│                                                             │
│ [執行檢索] [進一步優化] [儲存查詢模板]                        │
└────────────────────────────────────────────────────────────┘
```

**FR0.2: 混合查詢智能解析器**

**解析能力：**
1. **自然語言片段識別**
   - 偵測完整句子：「使用...的方法」、「...的系統」
   - 技術概念提取：「卡爾曼濾波器」、「荷電狀態」
   - 自動轉換為語義向量查詢

2. **Boolean 運算子識別**
   - 標準運算子：AND、OR、NOT
   - 近似運算子：NEAR/5、ADJ/3
   - 括號優先級處理

3. **專利號識別**
   - 格式：US10234567、EP3456789B1、WO2023/123456
   - 自動驗證專利號存在性
   - 提取專利向量用於「類似檢索」

4. **混合模式組合**
   - 自然語言 + Boolean：先語義檢索，再關鍵字篩選
   - 自然語言 + 專利號：結合概念與實例
   - 三者混合：最強大的檢索模式

**FR0.3: 即時查詢驗證與建議**

**驗證項目：**
```python
# 查詢驗證邏輯
def validate_query(query):
    issues = []
    suggestions = []

    # 1. 範圍評估
    estimated_results = estimate_result_count(query)
    if estimated_results > 50000:
        issues.append({
            "severity": "warning",
            "message": f"預估 {estimated_results:,} 件結果，可能過於寬泛",
            "suggestions": [
                "添加分類篩選（例如 H01M）",
                "添加日期範圍（例如 2020-2025）",
                "使用更具體的技術術語"
            ]
        })
    elif estimated_results < 10:
        issues.append({
            "severity": "warning",
            "message": f"預估僅 {estimated_results} 件結果，可能過於狹窄",
            "suggestions": [
                "移除部分 AND 條件",
                "使用同義詞擴展",
                "啟用語義檢索以增加召回率"
            ]
        })

    # 2. 模式平衡檢查
    if has_natural_language and not has_boolean:
        suggestions.append({
            "type": "enhancement",
            "message": "可添加關鍵字篩選以提高精確度",
            "example": "AND (battery OR cell)"
        })

    # 3. 專利號有效性
    if has_patent_numbers:
        invalid_patents = check_patent_validity(patent_numbers)
        if invalid_patents:
            issues.append({
                "severity": "error",
                "message": f"無效的專利號：{', '.join(invalid_patents)}",
                "suggestions": ["請檢查專利號格式"]
            })

    return issues, suggestions
```

**建議類型：**
- 🔴 **錯誤**：必須修正才能執行（例如無效專利號）
- 🟡 **警告**：建議修正以改善結果（例如過寬查詢）
- 💡 **增強**：可選的優化建議（例如添加同義詞）

**FR0.4: 引導式改進循環**

**迭代流程：**
```
執行檢索 → 查看結果 → AI 分析 → 建議改進 → 調整查詢 → 再次檢索
    ↑                                                        ↓
    └────────────────────────────────────────────────────────┘
                        持續優化直到滿意
```

**AI 分析結果品質：**
```
┌────────────────────────────────────────────────────────────┐
│ 📊 檢索結果分析                                              │
├────────────────────────────────────────────────────────────┤
│ 找到 5,123 件專利                                            │
│                                                             │
│ 結果品質評估：                                               │
│ ✅ 前 10 件平均相關度：0.87（高）                            │
│ ⚠️ 分類分佈：65% 集中在 H01M10/42（可能遺漏相關技術）        │
│ ✅ 時間分佈：2015-2025 均勻分佈                              │
│ ⚠️ 語言分佈：92% 英語（可能遺漏亞洲專利）                    │
│                                                             │
│ AI 建議改進：                                                │
│ 1. 添加相鄰分類 H02J7/00 以發現充電相關技術                  │
│ 2. 啟用多語言檢索以包含日文/韓文專利                         │
│ 3. 查看前 3 件最相關專利，考慮「類似此專利」擴展              │
│                                                             │
│ [接受建議 1] [接受建議 2] [手動調整] [結果已滿意]            │
└────────────────────────────────────────────────────────────┘
```

---

### 功能 1：混合查詢解析引擎 [P0]

**技術架構：**

```python
class HybridQueryParser:
    """混合查詢智能解析器"""

    def parse(self, raw_query: str) -> ParsedQuery:
        """
        解析混合查詢字串

        範例輸入：
        "使用卡爾曼濾波器估算鋰電池的荷電狀態 AND (SoC OR 'state of charge') 類似於 US10234567"

        輸出：
        ParsedQuery(
            natural_language=["使用卡爾曼濾波器估算鋰電池的荷電狀態"],
            boolean_logic="(SoC OR 'state of charge')",
            patent_references=["US10234567"],
            detected_mode="hybrid"
        )
        """
        # 1. 偵測專利號（正則表達式）
        patent_pattern = r'\b([A-Z]{2}\d{7,10}[A-Z]?\d?)\b'
        patents = re.findall(patent_pattern, raw_query)

        # 2. 偵測 Boolean 運算子
        boolean_pattern = r'\b(AND|OR|NOT|NEAR\/\d+|ADJ\/\d+)\b'
        has_boolean = bool(re.search(boolean_pattern, raw_query, re.IGNORECASE))

        # 3. 提取自然語言片段
        # 移除專利號和 Boolean 後剩下的就是自然語言
        nl_text = raw_query
        for patent in patents:
            nl_text = nl_text.replace(patent, '')
        nl_text = re.sub(boolean_pattern, '', nl_text, flags=re.IGNORECASE)
        nl_text = nl_text.strip()

        # 4. 決定檢索模式
        mode = self._determine_mode(nl_text, has_boolean, patents)

        return ParsedQuery(
            natural_language=nl_text if nl_text else None,
            boolean_logic=self._extract_boolean(raw_query) if has_boolean else None,
            patent_references=patents if patents else None,
            detected_mode=mode
        )

    def _determine_mode(self, nl_text, has_boolean, patents):
        """決定最佳檢索模式"""
        modes = []
        if nl_text: modes.append("semantic")
        if has_boolean: modes.append("boolean")
        if patents: modes.append("similar_patents")

        if len(modes) == 0:
            return "empty"
        elif len(modes) == 1:
            return modes[0]
        else:
            return "hybrid"  # 多種模式混合
```

**查詢執行策略：**

```python
class HybridSearchExecutor:
    """混合查詢執行引擎"""

    def execute(self, parsed_query: ParsedQuery) -> SearchResults:
        """根據解析結果執行最佳檢索策略"""

        if parsed_query.detected_mode == "hybrid":
            return self._execute_hybrid(parsed_query)
        elif parsed_query.detected_mode == "semantic":
            return self._execute_semantic(parsed_query.natural_language)
        elif parsed_query.detected_mode == "boolean":
            return self._execute_boolean(parsed_query.boolean_logic)
        elif parsed_query.detected_mode == "similar_patents":
            return self._execute_similar(parsed_query.patent_references)

    def _execute_hybrid(self, query: ParsedQuery):
        """混合模式：結合多種檢索結果"""
        results = []

        # 1. 語義檢索（如果有自然語言）
        if query.natural_language:
            semantic_results = self.semantic_search(
                query.natural_language,
                top_k=500
            )
            results.append(("semantic", semantic_results, 0.4))  # 權重 40%

        # 2. 類似專利檢索（如果有專利號）
        if query.patent_references:
            similar_results = self.similar_patent_search(
                query.patent_references,
                top_k=500
            )
            results.append(("similar", similar_results, 0.3))  # 權重 30%

        # 3. Boolean 關鍵字檢索
        if query.boolean_logic:
            boolean_results = self.boolean_search(
                query.boolean_logic,
                top_k=1000
            )
            results.append(("boolean", boolean_results, 0.3))  # 權重 30%

        # 4. 結合與排名
        final_results = self._merge_and_rank(results)

        return final_results

    def _merge_and_rank(self, results):
        """結合多個檢索結果並加權排名"""
        patent_scores = defaultdict(float)
        patent_sources = defaultdict(list)

        for source, patents, weight in results:
            for patent in patents:
                patent_scores[patent.id] += patent.score * weight
                patent_sources[patent.id].append(source)

        # 排序並返回
        ranked = sorted(
            patent_scores.items(),
            key=lambda x: x[1],
            reverse=True
        )

        return [
            {
                "patent_id": pid,
                "score": score,
                "sources": patent_sources[pid],  # ["semantic", "similar", "boolean"]
                "multi_source_bonus": len(patent_sources[pid]) > 1  # 多源匹配提升信心
            }
            for pid, score in ranked
        ]
```

---

### 功能 2：引導式 UI/UX [P0]

**設計原則：**
1. **逐步引導** - 分階段展開，不一次顯示所有選項
2. **即時反饋** - 每個輸入都有即時驗證和建議
3. **透明解釋** - 清楚說明 AI 在做什麼、為什麼建議
4. **快速逃生** - 任何階段都可跳過 AI 引導，手動輸入

**UI 組件：**

**組件 1：智能查詢輸入框**
```typescript
interface SmartQueryInput {
  // 即時解析與高亮
  onInput: (text: string) => {
    parsed: ParsedQuery,
    highlights: {
      naturalLanguage: Range[],  // 高亮自然語言片段（綠色）
      booleanOps: Range[],       // 高亮 Boolean 運算子（藍色）
      patentNumbers: Range[]     // 高亮專利號（橙色）
    },
    suggestions: Suggestion[]
  },

  // 自動完成
  autoComplete: {
    patents: PatentSuggestion[],      // 輸入專利號時自動完成
    keywords: KeywordSuggestion[],    // 技術關鍵字建議
    operators: ["AND", "OR", "NOT"]   // Boolean 運算子提示
  }
}
```

**組件 2：查詢建構助手**
```
┌────────────────────────────────────────────────────────────┐
│ 🛠️ 查詢建構助手（可選）                                      │
├────────────────────────────────────────────────────────────┤
│ 您可以直接在上方輸入框輸入，或使用助手逐步建構：              │
│                                                             │
│ 步驟 1/4：選擇核心概念                                       │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ 您的發明/技術關注什麼？                                │  │
│ │ ○ 電池技術                                             │  │
│ │ ○ 充電技術                                             │  │
│ │ ● 電池狀態估算                                         │  │
│ │ ○ 其他：____________                                   │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                             │
│ 步驟 2/4：指定技術方法                                       │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ 使用什麼方法或技術？（多選）                            │  │
│ │ ☑ 卡爾曼濾波器                                         │  │
│ │ ☑ 機器學習                                             │  │
│ │ ☐ 神經網路                                             │  │
│ │ ☐ 其他：____________                                   │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                             │
│ 步驟 3/4：添加參考專利（可選）                               │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ 輸入您已知的相關專利號：                                │  │
│ │ US10234567 ✅  EP3456789 ✅  [+ 添加更多]              │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                             │
│ 步驟 4/4：設定篩選條件（可選）                               │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ 分類：H01M10/42 (AI 建議) ✅                           │  │
│ │ 日期：2015 - 2025                                      │  │
│ │ 語言：英文 ✅  日文 ☐  中文 ☐  韓文 ☐                 │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                             │
│ [生成查詢] [重設] [直接輸入]                                 │
└────────────────────────────────────────────────────────────┘
```

**組件 3：結果品質儀表板**
```
┌────────────────────────────────────────────────────────────┐
│ 📊 檢索結果品質分析                                          │
├────────────────────────────────────────────────────────────┤
│ 總結果：5,123 件專利                                         │
│                                                             │
│ 多源驗證分佈：                                               │
│ 🟢 3 種模式都匹配（高信心）   ████████░░░░ 1,234 件 (24%)   │
│ 🟡 2 種模式匹配（中信心）     ██████████░░ 2,456 件 (48%)   │
│ 🔵 1 種模式匹配（待驗證）     ████░░░░░░░░ 1,433 件 (28%)   │
│                                                             │
│ 分類覆蓋率：                                                 │
│ H01M10/42 ████████████████░░ 65%                           │
│ H02J7/00  ████░░░░░░░░░░░░░░ 15%                           │
│ G01R31/36 ██░░░░░░░░░░░░░░░░ 10%                           │
│ 其他      ██░░░░░░░░░░░░░░░░ 10%                           │
│                                                             │
│ 時間趨勢：                                                   │
│ 📈 2020-2025: 3,200 件（62%，技術活躍）                     │
│ 📊 2015-2019: 1,500 件（29%）                               │
│ 📉 2015 前：  423 件（8%，較舊技術）                         │
│                                                             │
│ AI 建議：                                                    │
│ 💡 考慮添加 H02J7/00 分類以發現充電控制技術                  │
│ 💡 65% 集中在單一分類，可能遺漏相關技術                      │
│ 💡 前 10 件中有 3 件是多源匹配，建議優先審查                 │
│                                                             │
│ [應用建議] [查看多源匹配專利] [調整查詢]                      │
└────────────────────────────────────────────────────────────┘
```

---

## 更新後的使用者故事

### US1: 新手使用者 - 完全引導式首次檢索 🔥

**身分：** 新創公司工程師，第一次做專利檢索
**需求：** 系統一步步引導我，我只需要描述我的技術
**目的：** 零學習成本完成高品質專利檢索

**驗收標準：**
- ✅ 系統提供 3 種起點選擇（概念/專利號/關鍵字），我選「概念」
- ✅ 我輸入「用 AI 預測電池壽命」，系統自動解析為語義查詢
- ✅ 系統建議添加關鍵字 "AND (prediction OR estimation)"，我點擊接受
- ✅ 系統建議分類 H01M10/48，我點擊接受
- ✅ 預覽顯示預估 3,200 件結果，範圍適中
- ✅ 執行檢索後，系統分析結果品質並建議改進
- ✅ 最終達到 75% 召回率 vs. 專家基準（無引導只有 40%）

**MVP v2 解決方案：**
- 🔥 **引導式工作流程**：3 階段逐步建構查詢
- 🔥 **智能解析**：自動理解自然語言輸入
- 🔥 **即時建議**：每步都有 AI 提示和驗證
- 🔥 **結果分析**：檢索後提供品質評估和改進建議

---

### US2: 進階使用者 - 混合查詢快速輸入 🔥

**身分：** 專利審查員，熟悉 Boolean 查詢但想結合語義檢索
**需求：** 直接在一個輸入框輸入混合查詢，系統智能解析
**目的：** 不改變現有習慣，同時獲得 AI 增強

**驗收標準：**
- ✅ 在輸入框直接輸入：
  ```
  使用卡爾曼濾波器估算鋰電池的荷電狀態
  AND (SoC OR "state of charge" OR "battery charge")
  類似於 US10234567
  ```
- ✅ 系統即時解析並高亮：
  - 綠色：自然語言片段
  - 藍色：Boolean 運算子
  - 橙色：專利號
- ✅ 系統顯示解析結果：「偵測到 3 種查詢模式，將執行混合檢索」
- ✅ 預覽顯示：
  - 語義檢索：3,500 件
  - 關鍵字檢索：1,800 件
  - 類似專利：2,100 件
  - 總計（去重）：5,100 件
- ✅ 執行後，多源匹配的專利排名更高（信心度提升）
- ✅ 相比純 Boolean 查詢，召回率提升 60%

**MVP v2 解決方案：**
- 🔥 **混合查詢解析**：單一輸入框支援所有模式
- 🔥 **即時高亮與驗證**：輸入時即時反饋
- 🔥 **多源結果融合**：智能結合 3 種檢索結果
- 🔥 **多源信心分數**：多種模式都匹配的專利排名更高

---

### US3: 專利分析師 - 基於已知專利擴展檢索 🔥

**身分：** IP 分析師，手上有 5 件核心專利，想找更多類似技術
**需求：** 輸入這 5 件專利號，系統基於它們擴展檢索
**目的：** 快速建立完整的技術景觀地圖

**驗收標準：**
- ✅ 選擇起點「我知道一些相關專利」
- ✅ 輸入 5 個專利號：US10234567, EP3456789, JP2020-123456, KR102345678, CN109876543
- ✅ 系統驗證專利號有效性，全部 ✅
- ✅ 系統自動提取 5 件專利的共同技術特徵：
  - 共同分類：H01M10/42, H02J7/00
  - 共同關鍵詞：battery, state of charge, estimation, Kalman
  - 共同受讓人：Tesla, Panasonic, LG
- ✅ 系統建議查詢：「基於這 5 件專利的向量平均 + 共同技術特徵」
- ✅ 執行檢索返回 2,300 件類似專利
- ✅ 自動聚類為 6 個技術主題
- ✅ 每個主題顯示與原始 5 件專利的相似度
- ✅ 發現 850 件新專利（+37% 技術覆蓋）

**MVP v2 解決方案：**
- 🔥 **批量專利號處理**：支援多個專利號輸入
- 🔥 **共同特徵提取**：AI 分析多件專利的共同點
- 🔥 **向量平均查詢**：使用多個向量的平均作為查詢
- 🔥 **主題聚類**：自動組織擴展結果

---

### US4: 研發團隊 - 迭代改進查詢 🔥

**身分：** 研發團隊，執行多輪檢索，每輪根據結果調整
**需求：** 系統記住我的查詢歷史，支援快速比較和改進
**目的：** 透過迭代達到最佳檢索策略

**驗收標準：**
- ✅ 第 1 輪查詢：「電池壽命預測」→ 50,000 件結果（過寬）
- ✅ 系統建議：「過於寬泛，建議添加技術方法或分類篩選」
- ✅ 第 2 輪查詢：接受建議，添加「AND machine learning」→ 8,500 件（適中）
- ✅ 查看前 20 件結果，發現很多是電動車應用，但我們做儲能
- ✅ 系統建議：「偵測到大量電動車專利，是否排除？」
- ✅ 第 3 輪查詢：添加「NOT (vehicle OR automotive OR EV)」→ 3,200 件（精準）
- ✅ 系統並排比較 3 輪查詢的結果分佈
- ✅ 第 3 輪召回率 92%、精確度 78%（最佳平衡）
- ✅ 系統建議：「此查詢可儲存為模板『儲能電池壽命-ML方法』」

**MVP v2 解決方案：**
- 🔥 **迭代引導**：每輪檢索後提供具體改進建議
- 🔥 **歷史比較**：並排比較多輪查詢結果
- 🔥 **查詢模板**：儲存成功查詢供未來使用
- 🔥 **智能排除建議**：AI 偵測誤報模式並建議 NOT 條件

---

## 實作計畫（8 週）

### 衝刺 1-2（第 1-2 週）：混合查詢核心 [P0] 🔥

**第 1 週：混合查詢解析器**
- [ ] 第 1-2 天：混合查詢解析器（正則表達式 + NLP）
- [ ] 第 3 天：專利號驗證與提取
- [ ] 第 4 天：Boolean 邏輯解析與驗證
- [ ] 第 5 天：自然語言片段識別

**第 2 週：查詢執行引擎**
- [ ] 第 1-2 天：混合檢索執行引擎（語義 + Boolean + 類似專利）
- [ ] 第 3 天：多源結果融合與排名
- [ ] 第 4 天：即時結果預估 API
- [ ] 第 5 天：查詢驗證與建議引擎

**交付成果：** 混合查詢解析與執行核心功能

---

### 衝刺 3-4（第 3-4 週）：引導式 UI [P0] 🔥

**第 3 週：智能輸入與引導**
- [ ] 第 1-2 天：智能查詢輸入框（即時解析與高亮）
- [ ] 第 3 天：三階段引導式工作流程 UI
- [ ] 第 4 天：查詢建構助手（步驟式引導）
- [ ] 第 5 天：即時驗證與建議顯示

**第 4 週：結果分析與改進**
- [ ] 第 1-2 天：結果品質分析儀表板
- [ ] 第 3 天：迭代改進建議引擎
- [ ] 第 4 天：查詢歷史比較 UI
- [ ] 第 5 天：查詢模板儲存與管理

**交付成果：** 完整的引導式查詢體驗

---

### 衝刺 5-6（第 5-6 週）：增強功能 [P1]

**第 5 週：語義增強**
- [ ] 第 1-2 天：Solr 向量檢索整合（如前 MVP v2）
- [ ] 第 3 天：同義詞擴展與建議
- [ ] 第 4-5 天：結果聚類（使用向量）

**第 6 週：數據增強**
- [ ] 第 1-2 天：受讓人標準化
- [ ] 第 3 天：相鄰分類建議
- [ ] 第 4-5 天：專利家族去重

**交付成果：** 所有 AI 增強功能整合到引導流程

---

### 衝刺 7-8（第 7-8 週）：測試與優化

**第 7 週：品質測試**
- [ ] 第 1-2 天：混合查詢解析準確度測試（100 個測試案例）
- [ ] 第 3 天：引導式工作流程可用性測試（10 名使用者）
- [ ] 第 4-5 天：效能優化（解析延遲、檢索速度）

**第 8 週：Beta 測試**
- [ ] 第 1-3 天：Beta 使用者測試（20 名真實使用者）
  - 5 名新手（測試引導效果）
  - 10 名進階使用者（測試混合查詢）
  - 5 名專家（測試迭代改進）
- [ ] 第 4 天：根據反饋調整
- [ ] 第 5 天：文件與部署準備

**交付成果：** 生產就緒的引導式 AI 檢索系統

---

## 成功指標

### 使用者體驗指標

| 指標 | 基準 | 目標 | 測量方法 |
|------|------|------|---------|
| **首次查詢成功率** | 35% | 80% | 首次查詢即達到滿意結果的百分比 |
| **查詢建構時間** | 12 分鐘 | 5 分鐘 | 從開始到執行第一次檢索的時間 |
| **迭代次數** | 平均 5 輪 | 平均 2 輪 | 達到滿意結果的平均查詢輪數 |
| **引導採用率** | - | 70% | 選擇使用引導式工作流程的使用者 |
| **混合查詢使用率** | - | 60% | 使用混合查詢（2+ 模式）的比例 |

### 功能採用指標

| 功能 | 目標採用率 | 成功閾值 |
|------|-----------|---------|
| **引導式工作流程** | 70% | 新手使用者 90%、進階使用者 50% |
| **混合查詢輸入** | 60% | 進階使用者 80% |
| **即時建議接受** | 65% | 平均每次查詢接受 2+ 建議 |
| **迭代改進循環** | 50% | 使用者執行 2+ 輪改進 |
| **查詢模板儲存** | 30% | 成功查詢中 30% 被儲存 |

### 品質提升指標

| 指標 | 基準 | 目標 | 改進 |
|------|------|------|------|
| **召回率** | 基準 | +60% | 混合查詢 vs. 單一模式 |
| **精確度（前 100）** | 基準 | +40% | 多源匹配提升信心度 |
| **使用者滿意度** | 65% | 90% | 引導體驗顯著提升 |
| **新手成功率** | 40% | 75% | vs. 專家基準召回率 |

---

## 技術挑戰與解決方案

### 挑戰 1：混合查詢解析的複雜度

**問題：** 如何準確區分自然語言、Boolean 和專利號？

**解決方案：**
```python
# 多階段解析策略
def parse_hybrid_query(query):
    # 1. 先提取確定性內容（專利號）
    patents = extract_patent_numbers(query)

    # 2. 再識別 Boolean 運算子（關鍵字匹配）
    boolean_ops = extract_boolean_operators(query)

    # 3. 剩下的當作自然語言（使用 NER 驗證）
    remaining = remove_extracted_parts(query, patents, boolean_ops)
    nl_fragments = identify_natural_language(remaining)

    # 4. 驗證解析結果
    if not validate_parse(nl_fragments, boolean_ops, patents):
        # 要求使用者確認或調整
        return ask_user_to_clarify()

    return ParsedQuery(nl_fragments, boolean_ops, patents)
```

### 挑戰 2：即時結果預估的準確度

**問題：** 如何快速預估混合查詢的結果數量？

**解決方案：**
- 使用 Solr 的 `rows=0` 查詢（只返回計數，不返回文件）
- 快取常見查詢模式的結果數
- 使用統計模型預估（基於歷史查詢）

### 挑戰 3：引導流程的個性化

**問題：** 新手和專家需要不同程度的引導

**解決方案：**
```python
# 自適應引導級別
class AdaptiveGuidance:
    def get_guidance_level(self, user):
        # 根據使用者歷史判斷經驗等級
        search_count = user.get_search_count()
        success_rate = user.get_success_rate()

        if search_count < 5:
            return "beginner"  # 完整引導
        elif search_count < 20 or success_rate < 0.6:
            return "intermediate"  # 中等引導
        else:
            return "expert"  # 最少引導

    def render_ui(self, guidance_level):
        if guidance_level == "beginner":
            # 顯示完整 3 階段引導
            return render_full_guidance()
        elif guidance_level == "intermediate":
            # 顯示簡化引導 + 快速輸入選項
            return render_simplified_guidance()
        else:
            # 只顯示智能輸入框 + 可選助手
            return render_expert_mode()
```

---

## 與原 MVP v2 的整合

此版本**保留**原 MVP v2 的所有語義檢索功能，但重新組織為**引導式體驗**：

| 原 MVP v2 功能 | 整合方式 |
|--------------|---------|
| 語義相似度檢索 | 整合到混合查詢的「語義層」 |
| 語義聚類 | 整合到結果分析儀表板 |
| 「類似此專利」 | 整合到專利號輸入的自動建議 |
| 同義詞擴展 | 整合到引導式建議 |
| 受讓人標準化 | 整合到查詢優化建議 |
| 相鄰分類建議 | 整合到引導式工作流程 |

**核心改變：** 從「功能列表」→「引導式工作流程」

---

**建立日期：** 2025-10-19
**版本：** 2.1（引導式混合查詢）
**負責人：** AI Search Team (PatentCloud by InQuartik)
**憲法對齊：** v1.1.0
**優先級：** P0（核心使用者需求）
